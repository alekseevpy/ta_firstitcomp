{% extends "base.html" %}
{% load static %}

{% block content %}
<h1 class="h4 mb-3">Записи ДДС</h1>

<style>
    .table-readable th,
    .table-readable td {
        padding: .9rem 1rem;
        vertical-align: middle;
        font-size: 0.95rem;
    }

    .table-readable tbody tr {
        border-bottom: 1px solid rgba(0, 0, 0, .06);
    }

    .table-readable tbody tr:hover {
        background-color: var(--bs-table-hover-bg);
    }

    .table-readable .col-date,
    .table-readable .col-actions {
        white-space: nowrap;
    }

    .table-readable .col-comment {
        max-width: 520px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .filters-wrap {
        margin-bottom: 1.25rem;
    }

    .table-wrap {
        margin-bottom: 1rem;
    }
</style>

<div class="filters-wrap">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">С даты</label>
            {{ form.date_from }}
        </div>
        <div class="col-md-3">
            <label class="form-label">По дату</label>
            {{ form.date_to }}
        </div>
        <div class="col-md-2">
            <label class="form-label">Статус</label>
            {{ form.status }}
        </div>
        <div class="col-md-2">
            <label class="form-label">Тип</label>
            {{ form.type }}
        </div>
        <div class="col-md-2">
            <label class="form-label">Категория</label>
            {{ form.category }}
        </div>
        <div class="col-md-2">
            <label class="form-label">Подкатегория</label>
            {{ form.subcategory }}
        </div>
        <div class="col-md-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Фильтровать</button>
            <a href="{% url 'cashflow-list' %}" class="btn btn-outline-secondary">Сбросить</a>
            <a href="{% url 'cashflow-create' %}" class="btn btn-success ms-auto">+ Новая запись</a>
        </div>
    </form>
</div>

<div class="table-responsive table-wrap">
    <table class="table table-striped table-hover align-middle table-readable">
        <thead>
            <tr>
                <th class="col-date">Дата/время</th>
                <th>Тип</th>
                <th>Категория</th>
                <th>Подкатегория</th>
                <th class="text-end">Сумма</th>
                <th>Статус</th>
                <th class="col-comment">Комментарий</th>
                <th class="col-actions"></th>
            </tr>
        </thead>
        <tbody>
            {% for obj in page_obj.object_list %}
            <tr>
                <td class="col-date">{{ obj.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ obj.type.name }}</td>
                <td>{{ obj.category.name }}</td>
                <td>{{ obj.subcategory.name }}</td>
                <td class="text-end">{{ obj.amount }}</td>
                <td>{{ obj.status.name }}</td>
                <td class="col-comment">{{ obj.comment|default:"" }}</td>
                <td class="col-actions text-nowrap">
                    <a href="{% url 'cashflow-update' obj.pk %}" class="btn btn-sm btn-outline-primary">Изм.</a>
                    <form action="{% url 'cashflow-delete' obj.pk %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('Удалить запись?');">Удалить</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center text-muted py-4">Нет записей.</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="fw-semibold">
                <td colspan="4" class="text-end">Итого (страница):</td>
                <td class="text-end">{{ page_total }}</td>
                <td colspan="3"></td>
            </tr>
            <tr class="fw-semibold">
                <td colspan="4" class="text-end">Итого (всё по фильтру):</td>
                <td class="text-end">{{ full_total }}</td>
                <td colspan="3"></td>
            </tr>
        </tfoot>
    </table>
</div>

<nav aria-label="Навигация страниц">
    <ul class="pagination justify-content-center align-items-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link"
                href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}{% endif %}">
                «
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">«</span>
        </li>
        {% endif %}

        <li class="page-item disabled">
            <span class="page-link bg-transparent border-0 text-muted">
                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} страниц
            </span>
        </li>

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link"
                href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}{% endif %}">
                »
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">»</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endblock %}